<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="keccakStylesheet.css">
    <title>Keccak-f[25] Implementation</title>
</head>

<body>



    <h3>Keccak-f[25] Implementation</h3>

    <table id="frame">
        <th>
            <tr>
                <td>Input A[x,y]</td>
                <td>→</td>
                <td>Output New A[x,y]</td>
            </tr>
        </th>

        <tbody>
            <tr>
                <td align="center">
                    <table id="input">
                        <tr>
                            <td><input id="b00" type="number" min=0 max=1 value=0></td>
                            <td><input id="b01" type="number" min=0 max=1 value=0></td>
                            <td><input id="b02" type="number" min=0 max=1 value=0></td>
                            <td><input id="b03" type="number" min=0 max=1 value=0></td>
                            <td><input id="b04" type="number" min=0 max=1 value=0></td>
                        </tr>
                        <tr>
                            <td><input id="b10" type="number" min=0 max=1 value=0></td>
                            <td><input id="b11" type="number" min=0 max=1 value=0></td>
                            <td><input id="b12" type="number" min=0 max=1 value=0></td>
                            <td><input id="b13" type="number" min=0 max=1 value=0></td>
                            <td><input id="b14" type="number" min=0 max=1 value=0></td>
                        </tr>
                        <tr>
                            <td><input id="b20" type="number" min=0 max=1 value=0></td>
                            <td><input id="b21" type="number" min=0 max=1 value=0></td>
                            <td><input id="b22" type="number" min=0 max=1 value=0></td>
                            <td><input id="b23" type="number" min=0 max=1 value=0></td>
                            <td><input id="b24" type="number" min=0 max=1 value=0></td>
                        </tr>
                        <tr>
                            <td><input id="b30" type="number" min=0 max=1 value=0></td>
                            <td><input id="b31" type="number" min=0 max=1 value=0></td>
                            <td><input id="b32" type="number" min=0 max=1 value=0></td>
                            <td><input id="b33" type="number" min=0 max=1 value=0></td>
                            <td><input id="b34" type="number" min=0 max=1 value=0></td>
                        </tr>
                        <tr>
                            <td><input id="b40" type="number" min=0 max=1 value=0></td>
                            <td><input id="b41" type="number" min=0 max=1 value=0></td>
                            <td><input id="b42" type="number" min=0 max=1 value=0></td>
                            <td><input id="b43" type="number" min=0 max=1 value=0></td>
                            <td><input id="b44" type="number" min=0 max=1 value=0></td>
                        </tr>
                    </table>
                </td>

                <td><button id="show" onclick="keccak()">Show →</button></td>
                <td align="center">
                    <table id="output">
                        <tr>
                            <td id="a00" value=0>0</td>
                            <td id="a01" value=0>0</td>
                            <td id="a02" value=0>0</td>
                            <td id="a03" value=0>0</td>
                            <td id="a04" value=0>0</td>
                        </tr>
                        <tr>
                            <td id="a10" value=0>0</td>
                            <td id="a11" value=0>0</td>
                            <td id="a12" value=0>0</td>
                            <td id="a13" value=0>0</td>
                            <td id="a14" value=0>0</td>
                        </tr>
                        <tr>
                            <td id="a20" value=0>0</td>
                            <td id="a21" value=0>0</td>
                            <td id="a22" value=0>0</td>
                            <td id="a23" value=0>0</td>
                            <td id="a24" value=0>0</td>
                        </tr>
                        <tr>
                            <td id="a30" value=0>0</td>
                            <td id="a31" value=0>0</td>
                            <td id="a32" value=0>0</td>
                            <td id="a33" value=0>0</td>
                            <td id="a34" value=0>0</td>
                        </tr>
                        <tr>
                            <td id="a40" value=0>0</td>
                            <td id="a41" value=0>0</td>
                            <td id="a42" value=0>0</td>
                            <td id="a43" value=0>0</td>
                            <td id="a44" value=0>0</td>
                        </tr>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>

    <script>
        var a = [];

        // there are 12 rounds required for Keccak-f[25]. In this case, we need only RC[0] to RC[11] from the slide
        // since the 25-bits state only has 1 slice, i.e., z=0, only the first bit in each RCs is needed to extract.
        var RC = [0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0];


        function keccak() {
            readInput();

            // there are 12 rounds required for Keccak-f[25].
            for (let round = 0; round < 12; round++) {
                console.log("round: "+round);
                theta();
                pi();
                chi();
                iota(RC[round]);
            }

            // display result
            print();

        }

        // read input and store as matrix
        function readInput() {
            let bpos = "b"
            for (let i = 0; i < 5; i++) {
                let row = [];
                for (let j = 0; j < 5; j++) {
                    row[j] = document.getElementById(bpos + i + j).value;
                    
                }
                a[i] = row;
                console.log("a["+i+ "]"+a[i]);
                
            }
            
        }

        // theta step
        function theta() {
            let c = [];
            let d = [];
            for (let i = 0; i < 5; i++) {
                c[i] = a[0][i] ^ a[1][i] ^ a[2][i] ^ a[3][i] ^ a[4][i];
            }
            console.log("c"+c);


            for (let j = 0; j < 5; j++) {

                // j + 4 mod 5 should equals to j - 1 mod 5, and since javascript
                // cannnot handle negative number mod, therefore j+4 is used here.
                // and since this is Keccak-f[25], which means there's only 1 slice
                // therefore the rotation function rot() is eliminated here
                // i.e. rot(0,1) = 0, rot(1,1) = 1
                d[j] = c[(j + 4) % 5] ^ c[(j + 1) % 5];
            }
            console.log("d"+d);

            for (let m = 0; m < 5; m++) {
                for (n = 0; n < 5; n++) {
                    a[m][n] = a[m][n] ^ d[n];
                }
            }
            console.log("after theta: a"+a);

        }

        function pi() {
            let b = a;
            console.log("before pi: a"+a);

            for (let i = 0; i < 5; i++) {

                // arrange the row index to fit the order of a slice (2 1 0 4 3)
                let y = (5 - ((i + 3) % 5)) % 5;
                for (let j = 0; j < 5; j++) {

                    // arrange the column index to fit the order of a slice (3 4 0 1 2)
                    let x = (j + 3) % 5;

                    // apply the formula
                    b[y][(2 * x + 3 * y) % 5] = a[x][y];
                }
            }
            
            // update a
            a = b;
            console.log("after pi: a"+a);
        }

        // chi step
        function chi() {
            console.log("before chi: a"+a);
            let compA = [];
            let shiftA = [];

            for (let i = 0; i < 5; i++) {

                compA[i] = [];
                shiftA[i] = [];

                for (let j = 0; j < 5; j++) {

                    var m = (j + 1) % 5;
                    var n = (j + 2) % 5;

                    // javascript uses 32 bits signed integers for complement operation, i.e.  ~0 = -1, ~1 = -2.
                    // Therefore +2 in the expression.
                    compA[i][j] = (~a[i][m]) + 2;
                    shiftA[i][j] = a[i][n];
                    a[i][j] = a[i][j] ^ (compA[i][j] & shiftA[i][j]);
                }
            }
            console.log("after chi: a"+a);


        }



        function iota(round) {
            console.log("before iota: a[0][0]"+a[2][2])
            // a[0,0] (center of each slice) should be a[2][2] in js matrix
            a[2][2] = a[2][2] ^ round;
            console.log("after iota: a[0][0]"+a[2][2])
        }



        function print() {
            for (i = 0; i < 5; i++) {
                for (j = 0; j < 5; j++) {
                    document.getElementById("a" + i + j).innerHTML = a[i][j];
                }
            }
        }


    </script>



</body>

</html>