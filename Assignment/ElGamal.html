<!DOCTYPE html>
<html>

<head>
    <title>ElGamal Implementation</title>
</head>

<body>

    <h3>ElGamal Implementation</h3>


    <table cellspacing="30">
        <tr>
            <td>Prime p:</td>
            <td><input type="number" min=0 id="p" onchange="validInput()"></td>
            <td><span id="validp" style="color: red"></span></td>

        </tr>

        <tr>
            <td id="empty"></td>
            <td><button id="generateg" onclick="generateg()">Generate g ↓</button></td>
        </tr>

        <tr>
            <td>Generator g:</td>
            <td id="empty"><span id="g"></span><input id="gvalue" type="hidden" readonly value=""></td>
        </tr>

        <tr>
            <td>Private key x (2~p):</td>
            <td><input type="number" min=2 id="x" onchange="validx()"></td>
            <td><span id="validx" style="color: red"></span></td>
        </tr>

        <tr>
            <td id="empty"></td>
            <td><button id="generatex" onclick="generatey()">Generate y ↓</button></td>
        </tr>

        <tr>
            <td>y = g^x (mod p):</td>
            <td><span id="y"></span><input id="yvalue" type="hidden" value=""></td>
        </tr>

        <tr>
            <td>Public key (g, p, y):</td>
            <td id="publicKey"></td>
        </tr>

        <tr>
            <td>Message for c1:</td>
            <td><input type="number" id="c1m"></td>
            <td>Message for c2:</td>
            <td><input type="number" id="c2m"></td>
        </tr>

        <tr>
            <td>Random r for c1:</td>
            <td><input type="number" id="c1r"></td>
            <td>Random r for c2:</td>
            <td><input type="number" id="c2r"></td>
        </tr>

        <tr>
            <td id="empty"></td>
            <td><button id="encrypt" onclick="encrypt()">Encrypt ↓</button></td>
        </tr>

        <tr>
            <td>c1 = (g^r1, m1*y^r1) mod p:</td>
            <td><span id="c1"></span><input id="c11value" type="hidden" value=""><input id="c12value" type="hidden"
                    value=""></td>
            <td>c2 = (g^r2, m2*y^r2) mod p:</td>
            <td><span id="c2"></span><input id="c21value" type="hidden" value=""><input id="c22value" type="hidden"
                    value=""></td>
        </tr>

        <tr>
            <td id="empty"></td>
            <td><button id="encrypt" onclick="multiply()">Multiply ↓</button></td>
        </tr>

        <tr>
            <td>m1 * m2 (mod p):</td>
            <td><span id="m1m2"></span></td>
        </tr>

        <tr>
            <td>c1 * c2 (mod p):</td>
            <td><span id="c1c2"></span><input id="c1c21value" type="hidden" value=""><input id="c1c22value"
                    type="hidden" value=""></td>
        </tr>


        <tr>
            <td id="empty"></td>
            <td><button id="decrypt" onclick="decrypt()">Decrypt ↓</button></td>
        </tr>

        <tr>
            <td>D(C1):</td>
            <td><span id="d1"></span></td>
        </tr>

        <tr>
            <td>D(C2):</td>
            <td><span id="d2"></span></td>
        </tr>


        <tr>
            <td>D(c1*c2):</td>
            <td><span id="d12"></span></td>
        </tr>

    </table>


    <script>

        var pf = [];


        function pValid(num) {
            let n = Number(num);
            if (Number.isInteger(n) == false || n <= 1 || isPrime(num) == false) {
                return false;
            }

            return true;
        }

        function isPrime(test) {
            for (var i = 2; i < test; i++) {
                if (test % i === 0) {
                    return false;
                }
            }
            return true;
        }


        function validInput() {

            let input = Number(document.getElementById("p").value);
            if (pValid(input) == false) {
                document.getElementById("validp").innerHTML = "*p has to be a positive prime number."
            } else {
                document.getElementById("validp").innerHTML = "";
            }
            document.getElementById("x").max = input - 1;
        }


        // store prime factors of a number 
        function primeFactors(n) {
            let temp = [];
            pf = [];

            // Print the number of 2s that divide n 
            while (n % 2 == 0) {
                temp.push(2);
                n = n / 2;
            }

            // n must be odd at this point. So we can skip 
            // one element (Note i = i +2) 
            for (let i = 3; i <= Math.sqrt(n); i = i + 2) {
                // While i divides n, print i and divide n 
                while (n % i == 0) {
                    temp.push(i);
                    n = n / i;
                }
            }

            // when n is a prime number greater than 2 
            if (n > 2) {
                temp.push(n);
            }
            pf = new Set(temp);

        }


        // find the largest primitive root for p
        function generateg() {

            let p = Number(document.getElementById("p").value);

            if (isPrime(p) == false) {
                document.getElementById("g").innerHTML = "invalid p";
                return;
            }

            // Find value of Euler Totient function of n 
            // Since n is a prime number, the value of Euler 
            // Totient function is n-1 as there are n-1 
            // relatively prime numbers. 
            let phi = p - 1;
            primeFactors(phi);

            let a;

            for (let r = phi; r > 2; r--) {
                let flag = false;

                for (a of pf) {

                    // Check if r^((phi)/primefactors) mod p is 1
                    if (fastModExp(r, (phi / a), p) == 1) {
                        flag = true;
                        break;
                    }
                }

                // If there was no power with value 1. 
                if (flag == false) {

                    document.getElementById("gvalue").value = r;
                    document.getElementById("g").innerHTML = r;
                }
            }

        }



        function validx() {
            let x = Number(document.getElementById("x").value);
            let p = Number(document.getElementById("p").value);

            if (Number(x) >= Number(p) || Number(x) <= 1) {
                document.getElementById("validx").innerHTML = "* 1 < x < p."
                return false;
            } else {
                document.getElementById("validx").innerHTML = "";
                return true;
            }
        }



        function generatey() {
            if (validx() == true) {
                let x = Number(document.getElementById("x").value);
                console.log(x)
                let g = Number(document.getElementById("gvalue").value);
                console.log(g)
                let p = Number(document.getElementById("p").value);
                console.log(p)

                let y = fastModExp(g, x, p);
                document.getElementById("y").innerHTML = y;
                document.getElementById("yvalue").value = y;

                console.log(y)
                let publicKey = "(" + g + ", " + p + ", " + y + ")";
                document.getElementById("publicKey").innerHTML = publicKey;
                console.log(publicKey)
            } else {
                document.getElementById("publicKey").innerHTML = "invalid x";
            }
        }



        function encrypt() {
            let c1m = Number(document.getElementById("c1m").value);
            let c2m = Number(document.getElementById("c2m").value);
            let c1r = Number(document.getElementById("c1r").value);
            let c2r = Number(document.getElementById("c2r").value);
            let p = Number(document.getElementById("p").value);
            let g = Number(document.getElementById("gvalue").value);
            let y = Number(document.getElementById("yvalue").value);

            // Encryption: random r, c=E(m,y)=(gr,myr) 
            let c11 = fastModExp(g, c1r, p);
            let c12 = (c1m * Number(fastModExp(y, c1r, p))) % p;
            let c1 = "(" + c11 + ", " + c12 + ")";

            let c21 = fastModExp(g, c2r, p);
            let c22 = (c2m * Number(fastModExp(y, c2r, p))) % p;
            let c2 = "(" + c21 + ", " + c22 + ")";

            document.getElementById("c1").innerHTML = c1;
            document.getElementById("c2").innerHTML = c2;
            document.getElementById("c11value").value = c11;
            document.getElementById("c12value").value = c12;
            document.getElementById("c21value").value = c21;
            document.getElementById("c22value").value = c22;
        }


        function multiply() {
            let c1m = Number(document.getElementById("c1m").value);
            let c2m = Number(document.getElementById("c2m").value);
            let c11 = Number(document.getElementById("c11value").value);
            let c12 = Number(document.getElementById("c12value").value);
            let c21 = Number(document.getElementById("c21value").value);
            let c22 = Number(document.getElementById("c22value").value);
            let p = Number(document.getElementById("p").value);

            let m1m2 = (c1m * c2m) % p;
            let c1c21 = (c11 * c21) % p;
            let c1c22 = (c12 * c22) % p;
            let c1c2 = "(" + c1c21 + ", " + c1c22 + ")";


            document.getElementById("m1m2").innerHTML = m1m2;
            document.getElementById("c1c2").innerHTML = c1c2;
            document.getElementById("c1c21value").value = c1c21;
            document.getElementById("c1c22value").value = c1c22;
        }


        function decrypt() {
            let c11 = Number(document.getElementById("c11value").value);
            let c12 = Number(document.getElementById("c12value").value);
            let c21 = Number(document.getElementById("c21value").value);
            let c22 = Number(document.getElementById("c22value").value);
            let c1c21 = Number(document.getElementById("c1c21value").value);
            let c1c22 = Number(document.getElementById("c1c22value").value);
            let p = Number(document.getElementById("p").value);

            // -x mod p = p - 1 - x
            let minusX = p - 1 - Number(document.getElementById("x").value);

            // Decryption: c = (a,b), m = D(c,x) = b/a^x = (my^r/g^rx) = m
            let c1axinverse = Number(fastModExp(c11, minusX, p));
            let c2axinverse = Number(fastModExp(c21, minusX, p));
            let c1c2axinverse = Number(fastModExp(c1c21, minusX, p));
            let dc1 = (c1axinverse * c12) % p;
            let dc2 = (c2axinverse * c22) % p;
            let dc1c2 = (c1c2axinverse * c1c22) % p;

            document.getElementById("d1").innerHTML = dc1;
            document.getElementById("d2").innerHTML = dc2;
            document.getElementById("d12").innerHTML = dc1c2;
        }



        // for m^e % n
        function fastModExp(m, e, n) {
            var eBin = e.toString(2).split("");
            var eLen = eBin.length;
            //alert("e:"+eBin);
            var i = 0;
            var resTotal = 1;
            while (i < eLen) {
                if (i == 0) {
                    result = m % n;
                } else {
                    result = result * result;
                    result = result % n;
                }
                if (eBin[eLen - 1 - i] == 1) {
                    resTotal = resTotal * result;
                    resTotal = resTotal % n;
                }
                i++;
            }
            return resTotal;
        }
    </script>



</body>

</html>